---
layout: post
title: The Case of the Sudden OC4J Restarts [part 2]
excerpt: TL;DR for JDK 1.5, watch your Full GC frequency with sun.rmi.dgc.server.gcInterval/sun.rmi.dgc.client.gcInterval.
date: '2013-04-16T22:11:00.000-04:00'
author: George Aristy
categories:
- programming
- oracle-soa-suite
tags:
- rmi
- jvm
- oc4j
- oracle
- soa suite
- java
modified_time: '2013-04-16T22:11:37.465-04:00'
thumbnail: http://1.bp.blogspot.com/-DENa1BM5SuM/UW4Df1yhrEI/AAAAAAAAANk/j9SUxIqlZdA/s72-c/image001.jpg
blogger_id: tag:blogger.com,1999:blog-5903491164319093451.post-1722896470123368717
blogger_orig_url: http://llorllale.blogspot.com/2013/04/the-case-of-sudden-oc4j-restarts-part-2.html
---

<html> <head><meta http-equiv=Content-Type content="text/html; charset=windows-1252"><meta name=Generator content="Microsoft Word 12 (filtered)"><style><!--  /* Font Definitions */  @font-face  {font-family:Wingdings;  panose-1:5 0 0 0 0 0 0 0 0 0;} @font-face  {font-family:"Cambria Math";  panose-1:2 4 5 3 5 4 6 3 2 4;} @font-face  {font-family:Cambria;  panose-1:2 4 5 3 5 4 6 3 2 4;} @font-face  {font-family:Calibri;  panose-1:2 15 5 2 2 2 4 3 2 4;} @font-face  {font-family:Tahoma;  panose-1:2 11 6 4 3 5 4 4 2 4;}  /* Style Definitions */  p.MsoNormal, li.MsoNormal, div.MsoNormal  {margin-top:0in;  margin-right:0in;  margin-bottom:10.0pt;  margin-left:0in;  line-height:115%;  font-size:11.0pt;  font-family:"Calibri","sans-serif";} h1  {mso-style-link:"Heading 1 Char";  margin-top:24.0pt;  margin-right:0in;  margin-bottom:0in;  margin-left:0in;  margin-bottom:.0001pt;  line-height:115%;  page-break-after:avoid;  font-size:14.0pt;  font-family:"Cambria","serif";  color:#365F91;} p.MsoTitle, li.MsoTitle, div.MsoTitle  {mso-style-link:"Title Char";  margin-top:0in;  margin-right:0in;  margin-bottom:15.0pt;  margin-left:0in;  border:none;  padding:0in;  font-size:26.0pt;  font-family:"Cambria","serif";  color:#17365D;  letter-spacing:.25pt;} p.MsoTitleCxSpFirst, li.MsoTitleCxSpFirst, div.MsoTitleCxSpFirst  {mso-style-link:"Title Char";  margin:0in;  margin-bottom:.0001pt;  border:none;  padding:0in;  font-size:26.0pt;  font-family:"Cambria","serif";  color:#17365D;  letter-spacing:.25pt;} p.MsoTitleCxSpMiddle, li.MsoTitleCxSpMiddle, div.MsoTitleCxSpMiddle  {mso-style-link:"Title Char";  margin:0in;  margin-bottom:.0001pt;  border:none;  padding:0in;  font-size:26.0pt;  font-family:"Cambria","serif";  color:#17365D;  letter-spacing:.25pt;} p.MsoTitleCxSpLast, li.MsoTitleCxSpLast, div.MsoTitleCxSpLast  {mso-style-link:"Title Char";  margin-top:0in;  margin-right:0in;  margin-bottom:15.0pt;  margin-left:0in;  border:none;  padding:0in;  font-size:26.0pt;  font-family:"Cambria","serif";  color:#17365D;  letter-spacing:.25pt;} a:link, span.MsoHyperlink  {color:blue;  text-decoration:underline;} a:visited, span.MsoHyperlinkFollowed  {color:purple;  text-decoration:underline;} p.MsoDocumentMap, li.MsoDocumentMap, div.MsoDocumentMap  {mso-style-link:"Document Map Char";  margin:0in;  margin-bottom:.0001pt;  font-size:8.0pt;  font-family:"Tahoma","sans-serif";} p.MsoAcetate, li.MsoAcetate, div.MsoAcetate  {mso-style-link:"Balloon Text Char";  margin:0in;  margin-bottom:.0001pt;  font-size:8.0pt;  font-family:"Tahoma","sans-serif";} p.MsoListParagraph, li.MsoListParagraph, div.MsoListParagraph  {margin-top:0in;  margin-right:0in;  margin-bottom:10.0pt;  margin-left:.5in;  line-height:115%;  font-size:11.0pt;  font-family:"Calibri","sans-serif";} p.MsoListParagraphCxSpFirst, li.MsoListParagraphCxSpFirst, div.MsoListParagraphCxSpFirst  {margin-top:0in;  margin-right:0in;  margin-bottom:0in;  margin-left:.5in;  margin-bottom:.0001pt;  line-height:115%;  font-size:11.0pt;  font-family:"Calibri","sans-serif";} p.MsoListParagraphCxSpMiddle, li.MsoListParagraphCxSpMiddle, div.MsoListParagraphCxSpMiddle  {margin-top:0in;  margin-right:0in;  margin-bottom:0in;  margin-left:.5in;  margin-bottom:.0001pt;  line-height:115%;  font-size:11.0pt;  font-family:"Calibri","sans-serif";} p.MsoListParagraphCxSpLast, li.MsoListParagraphCxSpLast, div.MsoListParagraphCxSpLast  {margin-top:0in;  margin-right:0in;  margin-bottom:10.0pt;  margin-left:.5in;  line-height:115%;  font-size:11.0pt;  font-family:"Calibri","sans-serif";} span.TitleChar  {mso-style-name:"Title Char";  mso-style-link:Title;  font-family:"Cambria","serif";  color:#17365D;  letter-spacing:.25pt;} span.Heading1Char  {mso-style-name:"Heading 1 Char";  mso-style-link:"Heading 1";  font-family:"Cambria","serif";  color:#365F91;  font-weight:bold;} span.DocumentMapChar  {mso-style-name:"Document Map Char";  mso-style-link:"Document Map";  font-family:"Tahoma","sans-serif";} span.BalloonTextChar  {mso-style-name:"Balloon Text Char";  mso-style-link:"Balloon Text";  font-family:"Tahoma","sans-serif";} .MsoPapDefault  {margin-bottom:10.0pt;  line-height:115%;} @page WordSection1  {size:8.5in 11.0in;  margin:1.0in 1.0in 1.0in 1.0in;} div.WordSection1  {page:WordSection1;}  /* List Definitions */  ol  {margin-bottom:0in;} ul  {margin-bottom:0in;} --></style> </head> <body lang=EN-US link=blue vlink=purple> <div class=WordSection1> <p class=MsoNormal><i>[Please read part 1 <a href="http://llorllale.blogspot.com/2013/02/the-case-of-sudden-oc4j-restarts.html">here</a>.]</i></p> <p class=MsoNormal><b><span style='font-size:12.0pt;line-height:115%; color:red'>TL;DR: for JDK 1.5, watch your Full GC frequency with sun.rmi.dgc.server.gcInterval/sun.rmi.dgc.client.gcInterval</span></b></p> <p class=MsoNormal>Read on for more.</p> <p class=MsoNormal>Logging basic GC activity revealed very odd behavior:</p> <p class=MsoListParagraphCxSpFirst style='text-indent:-.25in'><em><b><span style='font-family:"Calibri","sans-serif";font-style:normal'>1.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></b></em><em><b><span style='font-family:"Calibri","sans-serif";font-style:normal'>Extended full garbage collection every evening at 10 pm.</span></b></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Looking through the logs I would reliably find a large spike in the duration of one full garbage collection cycle at the exact same hour. I still cannot ascertain the cause of this - I searched extensively and found nothing. I even went to #oracle @ freenode but got no answer. One thing I did notice while going back through the opmn.log: ping timeouts almost always occurred at this time, and, indeed, there was at least one instance when OPMN bounced the server at this hour.</span></em></p> <p class=MsoListParagraphCxSpMiddle style='text-indent:-.25in'><em><b><span style='font-family:"Calibri","sans-serif";font-style:normal'>2.<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></b></em><em><b><span style='font-family:"Calibri","sans-serif";font-style:normal'>Full garbage collection approximately every ~64 seconds.</span></b></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>This one was interesting. </span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>The Full GCs ran like clockwork instead of as a response to the server's load:</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <center><p class=MsoListParagraphCxSpMiddle style='text-indent:-.5in'><a href="http://1.bp.blogspot.com/-DENa1BM5SuM/UW4Df1yhrEI/AAAAAAAAANk/j9SUxIqlZdA/s1600/image001.jpg" imageanchor="1" ><img border="0" src="http://1.bp.blogspot.com/-DENa1BM5SuM/UW4Df1yhrEI/AAAAAAAAANk/j9SUxIqlZdA/s320/image001.jpg" /></a></p></center> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>At first it struck me as odd that the average interval between Full GCs would be 64 seconds as opposed to 60. Looking back now the answer is obvious. More on that later.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Memory usage was forcefully kept in check by the constant battering of the garbage collector but at the cost of processing time available to do actual work: the JVM was losing 7.53% of its time to garbage collection. Breaking this down further:</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <div align=center> <table class=MsoTableGrid border=1 cellspacing=0 cellpadding=0  style='margin-left:.5in;border-collapse:collapse;border:none'> <tr>  <td width=197 valign=top style='width:2.05in;border:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpMiddle style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>&nbsp;</span></em></p>  </td>  <td width=80 valign=top style='width:60.25pt;border:solid windowtext 1.0pt;   border-left:none;padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpMiddle style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><b><span style='font-family:"Calibri","sans-serif";   font-style:normal'>Young GC</span></b></em></p>  </td>  <td width=64 valign=top style='width:48.0pt;border:solid windowtext 1.0pt;   border-left:none;padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpLast style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><b><span style='font-family:"Calibri","sans-serif";   font-style:normal'>Full GC</span></b></em></p>  </td> </tr> <tr>  <td width=197 valign=top style='width:2.05in;border:solid windowtext 1.0pt;   border-top:none;padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpFirst style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><b><span style='font-family:"Calibri","sans-serif";   font-style:normal'>Avg mem. usage post gc (MB)</span></b></em></p>  </td>  <td width=80 valign=top style='width:60.25pt;border-top:none;border-left:   none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpMiddle style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>592</span></em></p>  </td>  <td width=64 valign=top style='width:48.0pt;border-top:none;border-left:none;   border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpLast style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>539</span></em></p>  </td> </tr> <tr>  <td width=197 valign=top style='width:2.05in;border:solid windowtext 1.0pt;   border-top:none;padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpFirst style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><b><span style='font-family:"Calibri","sans-serif";   font-style:normal'>Total memory freed (%)</span></b></em></p>  </td>  <td width=80 valign=top style='width:60.25pt;border-top:none;border-left:   none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpMiddle style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>98.5</span></em></p>  </td>  <td width=64 valign=top style='width:48.0pt;border-top:none;border-left:none;   border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpLast style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>1.5</span></em></p>  </td> </tr> <tr>  <td width=197 valign=top style='width:2.05in;border:solid windowtext 1.0pt;   border-top:none;padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpFirst style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><b><span style='font-family:"Calibri","sans-serif";   font-style:normal'>GC time spent (%)</span></b></em></p>  </td>  <td width=80 valign=top style='width:60.25pt;border-top:none;border-left:   none;border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpMiddle style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>3.6</span></em></p>  </td>  <td width=64 valign=top style='width:48.0pt;border-top:none;border-left:none;   border-bottom:solid windowtext 1.0pt;border-right:solid windowtext 1.0pt;   padding:0in 5.4pt 0in 5.4pt'>  <p class=MsoListParagraphCxSpLast style='margin:0in;margin-bottom:.0001pt;   line-height:normal'><em><span style='font-family:"Calibri","sans-serif";   font-style:normal'>96.4</span></em></p>  </td> </tr></table> </div> <p class=MsoListParagraphCxSpFirst><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>The numbers are clear: these Full GC cycles are not being effective at all - in fact, they look outright useless and are robbing our server of precious processing time to do actual work!</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>So what could be triggering constant full garbage collection? This puzzled me for a while.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>I went through all the parameters being passed to the JVM at startup: nothing. I felt confident about this finding yet I decided to put a final nail in the coffin and set the </span></em><em><span style='font-family: "Calibri","sans-serif"'>-XX:+DisableExplicitGC</span></em><em><span style='font-family:"Calibri","sans-serif";font-style:normal'> flag. This would also allow me to confirm if there exists some code somewhere in the JVM's classpath calling the System.gc() function. The results were striking:</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <center><p class=MsoListParagraphCxSpMiddle style='text-indent:-.5in'><a href="http://2.bp.blogspot.com/-WB7i4nrx36k/UW4EbwOEqVI/AAAAAAAAAN0/f-CDGdSHxtM/s1600/image002.jpg" imageanchor="1" ><img border="0" src="http://2.bp.blogspot.com/-WB7i4nrx36k/UW4EbwOEqVI/AAAAAAAAAN0/f-CDGdSHxtM/s320/image002.jpg" /></a></p></center> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>How much server uptime was lost to garbage collection now? 0.19%. Looking good.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Of course, average memory usage and allocation increased - as expected - and the JVM's natural garbage collection algorithm reliably kicked in and freed enough memory.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><b><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Who was calling System.gc() ?</span></b></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Good question.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>First order of business was to review our source code. System.gc() was nowhere to be found. Next - check all dependencies explicitly declared for our projects. Decompiling them all and searching revealed 5 classes: 2 were Oracle's (weblogic, orabpel) and the other was related to Mozilla's javascript engine. A very brief attempt at figuring out all the possible paths that can lead this code to call System.gc() was very quickly aborted: this is a very difficult task, and I would be leaving out the countless other classes in the JVM's classpath.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>I decided to dive into Oracle's KB to see what I can find. Answer: not much. Apparently, no one else was having this issue, or not many people have noticed it yet. I found quite a few articles detailing JVM troubleshooting methods, SOA Suite installation guides, etc., etc. - nothing of much use. Then, in passing, as a final note in an article liked to by another, I found mention of these uncommonly used startup parameters:</span></em></p> <p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'><em><span style='font-family:Symbol;font-style:normal'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></em><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>sun.rmi.dgc.server.gcInterval</span></em></p> <p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-indent:-.25in'><em><span style='font-family:Symbol;font-style:normal'>·<span style='font:7.0pt "Times New Roman"'>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; </span></span></em><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>sun.rmi.dgc.client.gcInterval</span></em></p> <p class=MsoListParagraphCxSpMiddle style='margin-left:1.0in;text-indent:-.5in'><em><span style='font-family:"Calibri","sans-serif";font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>You can read more about them <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/rmi/sunrmiproperties.html">here</a>. The default time of 1 hour mentioned there was not always the case - <a href="http://docs.oracle.com/javase/6/docs/technotes/guides/rmi/relnotes.html">it used to be 1 minute</a>. Our JDK was affected. </span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>The difference between those default 60 seconds and the ~64 seconds on average from the first graph above were enough to bug me - until I looked at the second graph again: the average duration of each Full GC hovered close to 4 seconds. 60 + ~4 ~= 64. :D</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Removing the </span></em><em><span style='font-family:"Calibri","sans-serif"'>-XX:+DisableExplicitGC</span></em><em><span style='font-family:"Calibri","sans-serif";font-style:normal'> flag and adding these two above, set to 1 hour each, proved fruitful: Full GCs were mostly limited to that hourly schedule.</span></em></p> <p class=MsoListParagraphCxSpMiddle><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>&nbsp;</span></em></p> <p class=MsoListParagraphCxSpLast><em><span style='font-family:"Calibri","sans-serif"; font-style:normal'>Now it's just a question of figuring out the best values for our needs (or whether we need these settings at all).</span></em></p> </div> </body> </html>
